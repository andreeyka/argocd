{{- /*
  MCP Authorization Policies
  Документация: https://agentgateway.dev/docs/kubernetes/latest/mcp/tool-access/
  
  Поддерживаются два типа политик:
  1. Политика для Multi Backend - ограничивает доступ к tools для всех MCP серверов
  2. Политики для Single Backends - ограничивает доступ к tools для каждого MCP сервера отдельно
  
  Примеры CEL выражений для matchExpressions:
  - 'mcp.tool.name == "add_issue_comment"' - доступ только к инструменту add_issue_comment
  - 'jwt.sub == "alice"' - доступ только для пользователя alice
  - 'jwt.sub == "alice" && mcp.tool.name == "get_me"' - alice может использовать только get_me
*/ -}}

{{- /* === Политика для Multi Backend === */ -}}
{{- if and .Values.mcp.multi.enabled .Values.mcp.multi.authorization.enabled }}
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: {{ .Values.mcp.multi.authorization.policyName | default (printf "%s-auth" .Values.mcp.multi.backend.name) }}
  namespace: {{ .Values.mcp.multi.backend.namespace | default .Values.mcp.defaults.namespace }}
spec:
  targetRefs:
    - group: agentgateway.dev
      kind: AgentgatewayBackend
      name: {{ .Values.mcp.multi.backend.name }}
  backend:
    mcp:
      authorization:
        action: {{ .Values.mcp.multi.authorization.action | default "Allow" }}
        policy:
          matchExpressions:
{{- range .Values.mcp.multi.authorization.matchExpressions }}
            - {{ . | quote }}
{{- end }}
{{- end }}

{{- /* === Политики для Single Backends === */ -}}
{{- if .Values.mcp.single.enabled }}
{{- $defaults := .Values.mcp.defaults }}
{{- $singleServers := list }}
{{- range .Values.mcp.singleServerFiles }}
{{- $file := printf "instances/single/%s" . }}
{{- $serverData := $.Files.Get $file | fromYaml }}
{{- $singleServers = append $singleServers $serverData }}
{{- end }}
{{- range $singleServers }}
{{- $server := mergeOverwrite (deepCopy $defaults) . }}
{{- $backendName := dig "backend" "name" $server.name $server }}
{{- /* Проверяем, есть ли authorization для этого сервера */ -}}
{{- if and $server.authorization $server.authorization.enabled }}
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: {{ $server.authorization.policyName | default (printf "%s-auth" $backendName) }}
  namespace: {{ $server.namespace | default $defaults.namespace }}
spec:
  targetRefs:
    - group: agentgateway.dev
      kind: AgentgatewayBackend
      name: {{ $backendName }}
  backend:
    mcp:
      authorization:
        action: {{ $server.authorization.action | default "Allow" }}
        policy:
          matchExpressions:
{{- range $server.authorization.matchExpressions }}
            - {{ . | quote }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
