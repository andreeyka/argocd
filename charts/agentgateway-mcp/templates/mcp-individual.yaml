{{- if .Values.mcp.individual.enabled }}
{{- $defaults := .Values.mcp.defaults }}
{{- /* Загружаем серверы из файлов */}}
{{- $individualServers := list }}
{{- range .Values.mcp.individualServerFiles }}
{{- $file := printf "instances/individual/%s" . }}
{{- $serverData := $.Files.Get $file | fromYaml }}
{{- $individualServers = append $individualServers $serverData }}
{{- end }}
{{- range $individualServers }}
{{- $server := mergeOverwrite (deepCopy $defaults) . }}
{{- $backendName := dig "backend" "name" $server.name $server }}
{{- $routeName := dig "route" "name" $server.name $server }}
{{- $routePath := dig "route" "path" (printf "/mcp/%s" $server.name) $server }}
{{- $routeGateway := dig "route" "gateway" $defaults.gateway $server }}
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: {{ $backendName }}
  namespace: {{ $server.namespace | default $defaults.namespace }}
spec:
  mcp:
    targets:
      # Individual MCP: каждый сервер имеет свой Backend с одним target
      - name: {{ $server.name }}
        selector:
          services:
            matchLabels:
              app: {{ $server.name }}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ $routeName }}
  namespace: {{ $server.namespace | default $defaults.namespace }}
spec:
  parentRefs:
    - name: {{ $routeGateway.name }}
      namespace: {{ $routeGateway.namespace }}
  rules:
    # Individual MCP: каждый сервер имеет свой HTTPRoute с уникальным путем
    # Используем Exact для точного совпадения пути
    - matches:
        - path:
            type: Exact
            value: {{ $routePath | quote }}
      backendRefs:
        - name: {{ $backendName }}
          group: agentgateway.dev
          kind: AgentgatewayBackend
{{- end }}
{{- end }}
