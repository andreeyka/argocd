{{- $defaults := .Values.mcp.defaults }}
{{- /* Загружаем серверы из файлов */}}
{{- $multiplexedServers := list }}
{{- range .Values.mcp.multiplexedServerFiles }}
{{- $file := printf "instances/multiplexed/%s" . }}
{{- $serverData := $.Files.Get $file | fromYaml }}
{{- $multiplexedServers = append $multiplexedServers $serverData }}
{{- end }}
{{- $individualServers := list }}
{{- range .Values.mcp.individualServerFiles }}
{{- $file := printf "instances/individual/%s" . }}
{{- $serverData := $.Files.Get $file | fromYaml }}
{{- $individualServers = append $individualServers $serverData }}
{{- end }}
{{- $allServers := list }}
{{- if .Values.mcp.multiplexed.enabled }}
{{- $allServers = concat $allServers $multiplexedServers }}
{{- end }}
{{- if .Values.mcp.individual.enabled }}
{{- $allServers = concat $allServers $individualServers }}
{{- end }}
{{- range $allServers }}
{{- $server := mergeOverwrite (deepCopy $defaults) . }}
{{- $deployment := dict "name" $server.name "namespace" ($server.namespace | default $defaults.namespace) "image" $server.image "imagePullPolicy" $server.imagePullPolicy "port" $server.port "replicas" $server.replicas "env" $server.env }}
{{- $serviceDefaults := $defaults.service | default dict }}
{{- $service := mergeOverwrite (deepCopy $serviceDefaults) ($server.service | default dict) }}
{{- $service = mergeOverwrite $service (dict "name" ($server.name) "port" ($server.port | default $defaults.port) "targetPort" ($server.port | default $defaults.port)) }}
{{- if $server.mcpPath }}
{{- $annotations := $service.annotations | default dict }}
{{- $annotations = mergeOverwrite $annotations (dict "kgateway.dev/mcp-path" $server.mcpPath) }}
{{- $service = mergeOverwrite $service (dict "annotations" $annotations) }}
{{- end }}
{{- $name := $service.name | default $deployment.name | default $server.name }}
{{- $appName := $deployment.name | default $server.name }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ $name }}
  namespace: {{ $service.namespace | default $deployment.namespace | default $defaults.namespace | default "agentgateway-system" }}
  labels:
    app: {{ $appName }}
    {{- if $service.labels }}
    {{- toYaml $service.labels | nindent 4 }}
    {{- end }}
  {{- if $service.annotations }}
  annotations:
    {{- toYaml $service.annotations | nindent 4 }}
  {{- end }}
spec:
  selector:
    app: {{ $appName }}
  type: {{ $service.type | default "ClusterIP" }}
  ports:
    - protocol: TCP
      port: {{ $service.port | default 8000 }}
      targetPort: {{ $service.targetPort | default ($deployment.port | default 8000) }}
      {{- if $service.appProtocol }}
      appProtocol: {{ $service.appProtocol }}
      {{- end }}
{{- end }}
