{{- if .Values.mcp.multiplexed.enabled }}
{{- /* Загружаем серверы из файлов */}}
{{- $multiplexedServers := list }}
{{- range .Values.mcp.multiplexedServerFiles }}
{{- $file := printf "instances/multiplexed/%s" . }}
{{- $serverData := $.Files.Get $file | fromYaml }}
{{- $multiplexedServers = append $multiplexedServers $serverData }}
{{- end }}
{{- if $multiplexedServers }}
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: {{ .Values.mcp.multiplexed.backend.name }}
  namespace: {{ .Values.mcp.multiplexed.backend.namespace | default .Values.mcp.defaults.namespace }}
spec:
  mcp:
    targets:
      {{- range $multiplexedServers }}
      # Multiplex MCP: каждый сервер создает свой target в одном Backend
      # Все серверы доступны через один endpoint /mcp
      # Инструменты будут доступны с префиксом имени сервера (например: ia-mcp-1_tool-name)
      - name: {{ .name }}
        selector:
          services:
            matchLabels:
              app: {{ .name }}
      {{- end }}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ .Values.mcp.multiplexed.route.name }}
  namespace: {{ .Values.mcp.multiplexed.route.namespace | default .Values.mcp.defaults.namespace }}
spec:
  parentRefs:
    - name: {{ (.Values.mcp.multiplexed.route.gateway | default .Values.mcp.defaults.gateway).name }}
      namespace: {{ (.Values.mcp.multiplexed.route.gateway | default .Values.mcp.defaults.gateway).namespace }}
  rules:
    # Multiplex MCP: один HTTPRoute для всех серверов
    # Все серверы доступны через один путь /mcp
    # Используем Exact, чтобы не перехватывать /mcp/server-name (individual endpoints)
    - backendRefs:
      - name: {{ .Values.mcp.multiplexed.backend.name }}
        group: agentgateway.dev
        kind: AgentgatewayBackend
      matches:
        - path:
            type: Exact
            value: {{ .Values.mcp.multiplexed.route.path | default "/mcp" | quote }}
{{- end }}
{{- end }}
