# Default values for agentgateway-mcp
# Этот файл используется как базовый values.yaml для Helm чарта
# Для переопределений используйте values-dev.yaml или values-prod.yaml

# Конфигурация для MCP серверов
# Поддерживаются два режима:
# 1. Multiplexing - все серверы за одним endpoint /mcp
# 2. Individual - каждый сервер на своем endpoint /mcp/server-name
# Можно использовать оба режима одновременно

mcp:
  # Список файлов серверов из instances/multiplexed/
  multiplexedServerFiles: []
  # Список файлов серверов из instances/individual/
  individualServerFiles: []

  # Общие настройки по умолчанию для всех MCP серверов
  defaults:
    namespace: agentgateway-system
    imagePullPolicy: Always
    port: 8000
    replicas: 1
    gateway:
      name: agentgateway-proxy
      namespace: agentgateway-system
    env:
      - name: MCP_HOST
        value: "0.0.0.0"
      # streamable-http обязателен для Multiplex MCP
      - name: MCP_TRANSPORT
        value: "streamable-http"
      - name: COLUMNS
        value: "200"
    service:
      appProtocol: kgateway.dev/mcp

  # === Режим 1: Multiplexing (все серверы за одним endpoint) ===
  # Multiplex MCP объединяет несколько MCP серверов в один Backend
  # Все серверы доступны через один endpoint /mcp
  # Инструменты от разных серверов доступны с префиксом имени сервера
  # Например: ia-mcp-1_tool-name, ia-mcp-2_tool-name, ia-mcp-3_tool-name
  # Важно: поддерживается только streamable-http транспорт (SSE не поддерживается)
  # Документация: https://agentgateway.dev/docs/kubernetes/latest/mcp/multiplex/
  multiplexed:
    enabled: true
    backend:
      name: mcp-multiplex
      namespace: agentgateway-system
    route:
      name: mcp
      namespace: agentgateway-system
      path: /mcp    # Один путь для всех
    # === Authorization Policy для Multiplexed Backend ===
    # Ограничивает доступ к MCP tools на основе JWT claims
    # Документация: https://agentgateway.dev/docs/kubernetes/latest/mcp/tool-access/
    authorization:
      enabled: false
      policyName: mcp-multiplex-auth  # Имя AgentgatewayPolicy
      action: Allow  # Allow или Deny
      # CEL выражения для контроля доступа к tools (OR логика)
      # Примеры:
      # - 'mcp.tool.name == "get_me"' - доступ только к tool get_me
      # - 'jwt.sub == "alice"' - доступ только для пользователя alice
      # - 'jwt.sub == "alice" && mcp.tool.name == "get_me"' - alice может использовать только get_me
      matchExpressions: []
      # matchExpressions:
      #   - 'jwt.sub == "alice"'
      #   - 'jwt.groups.exists(g, g == "admin")'

  # === Режим 2: Individual Endpoints (каждый сервер - свой endpoint) ===
  # Каждый MCP сервер получает свой Backend и HTTPRoute
  # Доступны через отдельные пути: /mcp/server1, /mcp/server2, etc.
  # Authorization Policy можно настроить для каждого сервера отдельно в instance файле:
  #   authorization:
  #     enabled: true
  #     policyName: my-server-auth
  #     action: Allow
  #     matchExpressions:
  #       - 'jwt.sub == "alice" && mcp.tool.name == "specific_tool"'
  individual:
    enabled: false
