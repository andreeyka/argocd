{{- if and .Values.jwtAuth.enabled .Values.jwtAuth.a2aPolicies.enabled }}
{{- range .Values.jwtAuth.a2aPolicies.httpRoutes }}
{{- $namespace := .namespace | default $.Values.jwtAuth.a2aPolicies.namespace }}
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: jwt-auth-{{ .name }}
  namespace: {{ $namespace }}
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: {{ .name }}
  traffic:
    jwtAuthentication:
      mode: {{ $.Values.jwtAuth.a2aPolicies.mode }}
      providers:
{{- range $.Values.jwtAuth.providers }}
      - issuer: {{ .issuer | quote }}
{{- if .audiences }}
        audiences:
{{- range .audiences }}
          - {{ . | quote }}
{{- end }}
{{- end }}
        jwks:
{{- if .jwks.remote }}
          remote:
            jwksPath: {{ .jwks.remote.jwksPath | quote }}
            cacheDuration: {{ .jwks.remote.cacheDuration | quote }}
            backendRef:
              group: {{ .jwks.remote.backendRef.group | quote }}
              kind: {{ .jwks.remote.backendRef.kind }}
              name: {{ .jwks.remote.backendRef.name }}
              namespace: {{ .jwks.remote.backendRef.namespace }}
              port: {{ .jwks.remote.backendRef.port }}
{{- end }}
{{- if .jwks.inline }}
          inline: {{ .jwks.inline | quote }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
